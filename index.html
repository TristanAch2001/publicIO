<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Interactive PaCMAP</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/plotly.js/2.26.0/plotly.min.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0; padding: 20px;
      background-color: #f5f5f5;
    }
    .container {
      max-width: 1400px; margin: 0 auto;
      background: white; border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      overflow: hidden;
    }
    .header {
      background: #2c3e50; color: white; padding: 20px;
      text-align: center;
    }
    .content {
      display: flex; min-height: 800px;
    }
    .plot-area {
      flex: 1; padding: 20px;
    }
    .controls {
      width: 300px; padding: 20px;
      border-left: 1px solid #eee;
      background: #fafafa;
    }
    .control-panel {
      background: white; border: 1px solid #ddd;
      border-radius: 6px; padding: 15px;
      margin-bottom: 20px;
    }
    .control-panel h4 {
      margin-top: 0; color: #2c3e50;
      border-bottom: 1px solid #eee; padding-bottom: 8px;
    }
    select, input[type="text"], input[type="range"] {
      width: 100%; padding: 8px;
      border: 1px solid #ddd; border-radius: 4px;
      margin-bottom: 10px; box-sizing: border-box;
    }
    button {
      background: #3498db; color: white;
      border: none; padding: 8px 16px;
      border-radius: 4px; cursor: pointer;
      margin-top: 5px;
    }
    button:hover {
      background: #2980b9;
    }
    .clear-btn {
      background: #95a5a6; font-size: 12px;
      margin-left: 4px;
    }
    .clear-btn:hover {
      background: #7f8c8d;
    }
    #plot {
      width: 100%; height: 800px;
    }
    .checkbox-container {
      display: flex; align-items: center;
      margin-bottom: 10px;
    }
    .checkbox-container input[type="checkbox"] {
      width: auto; margin-right: 8px; margin-bottom: 0;
    }
    .slider-container {
      margin-bottom: 15px;
    }
    .slider-label {
      display: flex; justify-content: space-between;
      margin-bottom: 5px; font-size: 14px;
    }
    .loading {
      display: flex; justify-content: center;
      align-items: center; height: 800px;
      font-size: 18px; color: #666;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>Interactive PaCMAP</h1>
    </div>
    <div class="content">
      <div class="plot-area">
        <div id="plot">
          <div class="loading">Loading data...</div>
        </div>
      </div>
      <div class="controls">
        <!-- Search Panel -->
        <div class="control-panel">
          <h4>Search Sample</h4>
          <input type="text" id="search-input" placeholder="Type sentrix_id..." list="sentrix-list"/>
          <datalist id="sentrix-list"></datalist>
          <button class="clear-btn" id="clear-search">Clear Search</button>
        </div>

        <!-- Highlight Panel -->
        <div class="control-panel">
          <h4>Highlight Controls</h4>
          <select id="highlight-types" multiple size="8"></select>
          <div>
            <button class="clear-btn" id="clear-highlight">Clear Highlights</button>
          </div>
          <div class="checkbox-container">
            <input type="checkbox" id="highlight-removed"/>
            <label for="highlight-removed">Highlight Removed Controls</label>
          </div>
          <div class="slider-container">
            <div class="slider-label">
              <span>Exclude samples removed up to round:</span>
              <span id="slider-value">0</span>
            </div>
            <input type="range" id="max-removed-round" min="0" max="12" value="0" step="1"/>
          </div>
        </div>

        <!-- Copy Selection Panel -->
        <div class="control-panel">
          <h4>Copy Selection</h4>
          <button id="copy-selection" disabled>Copy Selected Samples</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    
    const EMBEDDED_DATA = { /* â€¦ */ };
  

    class PacmapViewer {
      constructor() {
        this.fullData = null;
        this.typeColors = EMBEDDED_DATA.typeColors;
        this.lastSelectedIds = [];
        this.init();
      }

      init() {
        try {
          this.loadData();
          this.setupControls();
        } catch (err) {
          console.error('Error initializing app:', err);
          document.getElementById('plot').innerHTML =
            '<div class="loading">Error loading data. Please check console for details.</div>';
        }
      }

      loadData() {
        const umapData  = EMBEDDED_DATA.umapData;
        const metadata  = EMBEDDED_DATA.metadata;
        this.joinData(umapData, metadata);
        this.updatePlot();
      }

      joinData(umapData, metadata) {
        const map = new Map();
        metadata.forEach(r => {
          // normalize removed_control
          const rc = r.removed_control?.toString().toLowerCase();
          r.removed_control = (rc==='yes'||rc==='y') ? 1 : ((rc==='no'||rc==='n') ? 0 : parseInt(r.removed_control)||0);
          map.set(r.sentrix_id, r);
        });

        // include ids in layers
        this.fullData = umapData.map(u => {
          return { ...u, ...(map.get(u.sentrix_id)||{}) };
        }).filter(r => r.sentrix_id);
      }

      setupControls() {
        // populate search list
        const sentrixList = document.getElementById('sentrix-list');
        [...new Set(this.fullData.map(d=>d.sentrix_id))].sort()
          .forEach(id => {
            const opt = document.createElement('option');
            opt.value = id;
            sentrixList.appendChild(opt);
          });

        // populate highlight-types
        const typesSel = document.getElementById('highlight-types');
        [...new Set(this.fullData.map(d=>d['label.type']))].sort()
          .filter(t=>t).forEach(type => {
            const opt = document.createElement('option');
            opt.value = type;
            opt.textContent = type;
            typesSel.appendChild(opt);
          });

        // wire up controls
        document.getElementById('search-input')
          .addEventListener('input', ()=>this.updatePlot());
        document.getElementById('clear-search')
          .addEventListener('click', ()=>{
            document.getElementById('search-input').value='';
            this.updatePlot();
          });
        document.getElementById('highlight-types')
          .addEventListener('change', ()=>this.updatePlot());
        document.getElementById('clear-highlight')
          .addEventListener('click', ()=>{
            const sel = document.getElementById('highlight-types');
            for(let i=0; i<sel.options.length; i++) sel.options[i].selected = false;
            this.updatePlot();
          });
        document.getElementById('highlight-removed')
          .addEventListener('change', ()=>this.updatePlot());
        document.getElementById('max-removed-round')
          .addEventListener('input', e=>{
            document.getElementById('slider-value').textContent = e.target.value;
            this.updatePlot();
          });

        // copy-selection button
        document.getElementById('copy-selection')
          .addEventListener('click', ()=>{
            if(!this.lastSelectedIds.length) return;
            navigator.clipboard.writeText(this.lastSelectedIds.join('\n'))
              .then(()=> alert(Copied ${this.lastSelectedIds.length} sample IDs))
              .catch(err => console.error('Copy failed:', err));
          });
      }

      updatePlot() {
        // filter rounds
        let data = [...this.fullData];
        const maxRound = +document.getElementById('max-removed-round').value;
        if(maxRound>0) {
          data = data.filter(d =>
            !(d.PCA_removed_round > 0 && d.PCA_removed_round <= maxRound)
          );
        }

        const searchVal = document.getElementById('search-input').value.trim();
        const highlightTypes = Array.from(
          document.getElementById('highlight-types').selectedOptions
        ).map(o=>o.value);
        const highlightRemoved = document.getElementById('highlight-removed').checked;

        const layers = this.preparePlotData(data, searchVal, highlightTypes, highlightRemoved);
        this.createPlot(layers);
      }

      preparePlotData(data, searchVal, highlightTypes, highlightRemoved) {
        const layers = {
          other:       { x:[], y:[], text:[], ids:[], name:'Other' },
          highlighted: {}, 
          searched:    { x:[], y:[], text:[], ids:[], name:'SEARCHED' }
        };

        data.forEach(d => {
          const hover = [
            Sample: ${d.sentrix_id},
            Patient ID: ${d.Patient_ID||'N/A'},
            True Type: ${d['label.type']} ,
            <b>Pred Type:</b> ${d.max_label_type} (${(+d.max_label_score_type).toFixed(3)}/${(+d.correct_label_score_type).toFixed(3)})
          ].join('<br>');

          // decide layer
          if(searchVal && d.sentrix_id===searchVal) {
            layers.searched.x.push(d.Dim1);
            layers.searched.y.push(d.Dim2);
            layers.searched.text.push(hover);
            layers.searched.ids.push(d.sentrix_id);

          } else if(highlightRemoved && d.removed_control===1) {
            const key='Removed';
            if(!layers.highlighted[key]) layers.highlighted[key] = { x:[], y:[], text:[], ids:[], name:key };
            layers.highlighted[key].x.push(d.Dim1);
            layers.highlighted[key].y.push(d.Dim2);
            layers.highlighted[key].text.push(hover);
            layers.highlighted[key].ids.push(d.sentrix_id);

          } else if(highlightTypes.length && highlightTypes.includes(d['label.type'])) {
            const key=d['label.type'];
            if(!layers.highlighted[key]) layers.highlighted[key] = { x:[], y:[], text:[], ids:[], name:key };
            layers.highlighted[key].x.push(d.Dim1);
            layers.highlighted[key].y.push(d.Dim2);
            layers.highlighted[key].text.push(hover);
            layers.highlighted[key].ids.push(d.sentrix_id);

          } else if(!highlightTypes.length && !highlightRemoved) {
            const key=d['label.type']||'Unknown';
            if(!layers.highlighted[key]) layers.highlighted[key] = { x:[], y:[], text:[], ids:[], name:key };
            layers.highlighted[key].x.push(d.Dim1);
            layers.highlighted[key].y.push(d.Dim2);
            layers.highlighted[key].text.push(hover);
            layers.highlighted[key].ids.push(d.sentrix_id);

          } else {
            layers.other.x.push(d.Dim1);
            layers.other.y.push(d.Dim2);
            layers.other.text.push(hover);
            layers.other.ids.push(d.sentrix_id);
          }
        });

        return layers;
      }

      createPlot(layers) {
        const traces = [];

        if(layers.other.x.length) {
          traces.push({
            x: layers.other.x, y: layers.other.y,
            text: layers.other.text, customdata: layers.other.ids,
            mode: 'markers', type: 'scatter',
            name: 'Other',
            marker: { color: '#E0E0E0', size:6, opacity:0.4 },
            hovertemplate: '%{text}<extra></extra>'
          });
        }
        Object.values(layers.highlighted).forEach(layer=> {
          if(!layer.x.length) return;
          traces.push({
            x: layer.x, y: layer.y,
            text: layer.text, customdata: layer.ids,
            mode: 'markers', type: 'scatter',
            name: layer.name,
            marker: {
              color: this.typeColors[layer.name]||'#999999',
              size: 8, opacity: 0.7
            },
            hovertemplate: '%{text}<extra></extra>'
          });
        });
        if(layers.searched.x.length) {
          traces.push({
            x: layers.searched.x, y: layers.searched.y,
            text: layers.searched.text, customdata: layers.searched.ids,
            mode: 'markers', type: 'scatter',
            name: 'SEARCHED',
            marker: { color:'#FF0000', size:12, opacity:1, line:{color:'#000',width:2} },
            hovertemplate: '%{text}<extra></extra>'
          });
        }

        const layout = {
          xaxis: { title: 'Dim 1' }, yaxis: { title: 'Dim 2' },
          hovermode: 'closest',
          margin: { l:50, r:150, t:50, b:50 },
          legend: { orientation: 'v', x:1.02, y:1 }
        };
        const config = {
          responsive: true,
          displayModeBar: true,
          dragmode: 'zoom'
        };

        const plotDiv = document.getElementById('plot');
        Plotly.newPlot(plotDiv, traces, layout, config)
          .then(() => {
            // enable selection copy
            plotDiv.on('plotly_selected', evt => {
              this.lastSelectedIds = evt.points.map(p=>p.customdata);
              document.getElementById('copy-selection').disabled = !this.lastSelectedIds.length;
            });
          });
      }
    }

    window.addEventListener('DOMContentLoaded', () => new PacmapViewer());
  </script>
</body>
</html>
